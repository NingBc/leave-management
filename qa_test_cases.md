# 年假管理系统 - 专业测试用例文档 (QA 版)

本用例专注于年假核心逻辑（计算、结转、扣减、同步），包含边界值测试及系统逻辑验证。

## 1. 员工档案与配额初始化 (Quota Initialization)

| ID | 功能点 | 测试场景 | 预期结果 | 
| :--- | :--- | :--- | :--- |
| L-01 | 标准额度 | 工龄边界值测试 (1年, 10年, 20年) | 0-1年: 0天; 1-10年: 5天; 10-20年: 10天; >=20年: 15天。 |
| L-02 | 实际额度 | 当年入职员工比例折算 | 实际额度 = 标准额度 * (当年在职天数 / 365)，结果向下舍入至 0.5 的倍数。 |
| L-03 | 自动创建 | 新增用户账户同步触发 | 添加符合条件的用户后，`leave_account` 表应自动生成对应年份的记录。 |
| L-04 | 未来年度 | 跨年提前初始化 (2025年初始化2026年) | 由于未进入该年份，2026年实际配额应为 0（符合系统设计：不预支未来额度）。 |

## 2. 扣减优先级与过期逻辑 (Deduction & Expiry)

| ID | 功能点 | 测试场景 | 预期结果 |
| :--- | :--- | :--- | :--- |
| D-01 | 扣减优先级 | 混合额度扣减 (结转+当年) | 优先扣减 `expiry_date` 最近的记录（通常是上年结转额度）。 |
| D-02 | 过期清理 | 定时任务精确清理 (1月1日执行) | 系统通过 `ScheduledTasks` 扫描 12月31日过期的记录，生成 `EXPIRED` 记录日期为 **12月31日**。 |
| D-03 | 结转计算 | 结转额度去噪 (排除 EXPIRED 记录) | 结转下一年余额时，必须忽略 `EXPIRED` 类型的负数记录，防止余额双倍扣减。 |
| D-04 | 借支逻辑 | 余额不足自动预支 (Borrowing) | 当结转和当年额度均不足时，系统应能自动占用下一年度名义额度，记录显示为“预支”。 |

## 3. 记录手动调整 (Manual Adjustments)

| ID | 功能点 | 测试场景 | 预期结果 |
| :--- | :--- | :--- | :--- |
| A-01 | 额度奖励 | 同步更新 `totalBalance` | 添加 `ADJUSTMENT_ADD` 记录后，账户余额应实时增加。 |
| A-02 | 额度扣除 | 符号自动修正 | 后端自动处理绝对值，确保 `ADJUSTMENT_DEDUCT` 在数据库中存储为负数。 |
| A-03 | 备注回溯 | 特殊备注持久化 | 验证 `remarks` 字段在列表和详情弹窗中显示完整，无截断。 |

## 4. 钉钉同步与数据一致性 (Integration)

| ID | 功能点 | 测试场景 | 预期结果 |
| :--- | :--- | :--- | :--- |
| S-01 | 数据拉取 | 2天回溯窗口验证 | 检查 API 请求参数中的 `fromDate` 是否为 `today - 2 days`。 |
| S-02 | 幂等性 | 重复同步测试 | 钉钉多次推送同一请假单，系统应能通过 `user_id`, `start_date`, `days` 匹配实现去重。 |
| S-03 | 审批联动 | 驳回审批后的影响 | 若钉钉同步时记录已存在但发生变更（虽然当前逻辑主要增量统计），需验证系统是否重复产生扣减。 |

## 5. 存储过程与数据库边界 (DB/Boundary)

| ID | 功能点 | 测试场景 | 预期结果 |
| :--- | :--- | :--- | :--- |
| B-01 | 并发申请 | 多名员工同时模拟请假 | 事务一致性，防止 `totalBalance` 在并发更新时出现脏数据。 |
| B-02 | 软删除 | 离职员工账户处理 | 员工离职后，其年假账户 `deleted` 标记为 1，查询统计时不应出现。 |

---
> [!TIP]
> **QA 提示：** 
> 重点关注 `LeaveServiceImpl.java` 中的 `calculateCarryOverBalance` 与 `deductLeaveDays` 方法，这是系统最核心的逻辑枢纽。
